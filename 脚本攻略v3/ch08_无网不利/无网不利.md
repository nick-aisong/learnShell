无网不利
========

| 目录                         | 主要命令                        |
| ---------------------------- | ------------------------------- |
| 网络设置                     | ifconfig, route, nslookup, host |
| ping!                        | ping                            |
| 跟踪IP路由                   | traceroute                      |
| 列出网络中所有的活动主机     | ping, fping                     |
| 使用SSH在远程主机上执行命令  | ssh                             |
| 在远程主机上执行图形化命令   |                                 |
| 通过网络传输文件             |                                 |
| 连接无线网络                 |                                 |
| 实现SSH的无密码自动登录      |                                 |
| 使用SSH实现端口转发          |                                 |
| 在本地挂载点上挂载远程驱动器 |                                 |
| 分析网络流量与端口           |                                 |
| 测量网络带宽                 |                                 |
| 创建套接字                   |                                 |
| 搭建网桥                     |                                 |
| Internet连接共享             |                                 |
| 使用iptables架设简易防火墙   |                                 |
| 创建虚拟私有网络             |                                 |

#### 网络设置

ifconfig命令用于配置及显示网络接口、子网掩码等细节信息

它通常位于 /sbin/ifconfig 中  

```shell
ifconfig  # 列出当前的网络接口配置

ifconfig wlan0 192.168.0.80  # 设置网络接口的IP地址

ifconfig wlan0 192.168.0.80 netmask 255.255.252.0  # 设置此IP地址的子网掩码

dhclient eth0  # 使用动态主机配置协议（DHCP）自动为连接到网络上的计算机分配IP地址

# 打印网络接口列表
ifconfig | awk -F ':' '{print$1}' | grep -v '^ ' | tr -d ' ' | tr -s '\n'

# 显示IP地址
ifconfig iface_name 
```

- HWaddr 00:1c:bf:87:25:d2 是硬件地址（MAC地址）
- inet addr: 192.168.0.82 是IP地址
- Bcast: 192.168.3.255 是广播地址
- Mask: 255.255.252.0 是子网掩码

```shell
# 从ifconfig输出中提取IP地址
ifconfig ens32 | egrep -o "inet [^ ]*" | grep -o "[0-9.]*"

#  硬件地址（MAC地址）欺骗 (机器重启之后失效)
ifconfig eth0 hw ether 00:1c:bf:87:25:d5
```

名字服务器与DNS（域名服务）

```shell
 cat /etc/resolv.conf
 
 # 获取域名所对应IP地址的最简单方法就是用ping命令访问指定的域名
 ping google.com 
```

一个域名可以对应多个IP地址。对于这种情况，ping只会显示其中的一个地址。要想获取分配给域名的所有IP地址，就得使用DNS查找工具了

DNS查找

```shell
# host命令会列出某个域名所有的IP地址
host google.com

# nslookup命令可以完成名字与IP地址之间的相互映射
nslookup google.com

# 通过向文件/etc/hosts中加入条目来实现名字解析
echo 192.168.0.9 backupserver backupserver.example.com >> /etc/hosts
```

显示路由表信息

```shell
# route命令可以显示路由表
route

route -n # -n指定以数字形式显示地址，默认情况下，route命令会将IP地址映射为名字

# route add命令可以添加默认网关
route add default gw IP_ADDRESS INTERFACE_NAME 
route add default gw 192.168.0.1 wlan0 
```

#### ping!

ping是一个基础的网络命令，所有主流操作系统都支持该命令。ping可用于检验网络上主机之间的连通性，找出活动主机

原理：

ping命令使用Internet控制消息协议（Internet Control Message Protocol，ICMP）中的echo分
组检验网络上两台主机之间的连通性。当向某台主机发送echo分组时，如果分组能够送达且该
主机处于活动状态，那么它就会返回一条回应（reply）。如果没有通往目标主机的路由或是目标
主机不知道如何将回应返回给请求方，ping命令则执行失败

```shell
ping ADDRESS # 检查某台主机是否可达
```

注意：

网络管理员通常会对网络设备（如路由器）进行配置，使其不响应ping命
令。这样做是为了降低安全风险，因为ping可以被攻击者（使用蛮力）用来获
取主机的IP地址

补充内容：

1. 往返时间

  ping命令可以显示出每个分组的往返时间（Round Trip Time，RTT）。RTT的单位是毫秒。在
  内部网络中，RTT基本上还不到1ms。在Internet上，RTT通常在10ms到400ms之间，有可能还会
  超过1000ms

2.  序列号

   ping发出的每个分组都有一个序列号，从1开始，直到ping命令结束。如果网络接近饱和，
   分组可能会因为冲突、重试或被丢弃的原因，以乱序的形式返回

3. 生存时间

   ping命令发送的每个分组都有一个可以在被丢弃前完成的跳数，这个值是预先定义好的。
   分组途径的每个路由器会将该值减1。它表明了发出ping命令的主机和目的主机之间相隔了多少
   个路由器。依据你所使用的系统或ping命令版本的不同，生存时间（Time To Live，TTL）的初
   始值也不尽相同。你可以通过向环回接口发起ping命令来确定TTL的初始值

4. 限制发送的分组数量

   ping命令会不停地发送echo分组并等待回复，直到按下Ctrl+C为止。我们可以用选项-c限
   制所发送的echo分组的数量。用法如下：

```shell
ping 192.168.0.1 -c 2 # -c COUNT 
```

5. ping命令的返回状态

   ping命令如果执行顺利，会返回退出状态0；否则，返回非0。执行顺利意味着目标主机可
   达，执行失败意味着目标主机不可达

```shell
$ ping domain -c2
if [ $? -eq 0 ];
then
 echo Successful ;
else
 echo Failure
fi
```

#### 跟踪 IP 路由

当应用程序通过Internet请求服务时，服务器可能位于远端，两者之间通过多个网关或路由器
相连。traceroute命令可以显示分组途径的所有网关的地址。这些信息可以帮助我们搞明白分
组到达目的地需要经过多少跳。中途的网关或路由器的数量给出了网络上两个节点之间的有效距
离，这未必和物理距离有关。传输时间会随着每一跳增加。对于路由器而言，接收、解析以及发
送分组都是需要花时间的

traceroute命令的格式如下：

```shell
traceroute destinationIP # destinationIP 可以是IP地址，也可以是域名
```

注意：

如今的Linux发布版中还包括了一个命令mtr，它类似于traceroute，但是
能够显示实时刷新的数据。这对于检查网络线路质量等问题很有帮助

#### 列出网络中所有的活动主机

在这则攻略中，我们演示了两种方法。分别使用ping和fping。在脚本中使用fping更容易
些，而且比ping拥有更多的特性。fping默认并没有包含在Linux发行版中，需要用软件包管理
器手动安装

详见ping.sh

缺点：

在这个脚本中，每个地址对应一个ping命令，依次执行。这就使得如果出现某个IP地址不回
应的话，整个脚本的运行速度就会被拖慢，因为在发出下一次ping之前，必须等上一次的ping
超时

1. 并行ping 

可以开启多进程，详见fast_ping.sh

2. 使用fping

第二种方法使用了另一个命令fping。它可以为多个IP地址生成ICMP分组，然后等待回应。
其运行速度要比之前的脚本快得多

fping的选项如下：

- 选项 -a指定显示出所有活动主机的IP地址
- 选项 -u指定显示出所有不可达的主机
- 选项 -g指定从“IP地址/子网掩码”记法或者“IP地址范围”记法中生成一组IP地址

```shell
fping -a 192.160.1/24 -g 
fping -a 192.160.1 192.168.0.255 -g 
```

- 2>/dev/null用于将由于主机不可达所产生的错误信息输出到null设备

其他用法：

```shell
fping -a 192.168.0.1 192.168.0.5 192.168.0.6 # 将IP地址作为参数传递
fping -a < ip.list # 从文件中传递一组IP地址
```

#### 使用 SSH 在远程主机上执行命令

SSH代表的是Secure Shell（安全shell）。它使用加密隧道连接两台计算机。SSH能够让你访问
远程计算机上的shell，从而在其上执行交互命令并接收结果，或是启动交互会话

GNU/Linux发布版中默认并不包含SSH，需要使用软件包管理器安装openssh-server和
openssh-client。SSH服务默认运行在端口22之上

```shell
ssh username@remote_host
```

注意：

SSH会询问用户密码，一旦认证成功，就会连接到远程主机上的登录shel

SSH执行指纹核对（fingerprint verification）来确保用户连接到正确的远程主机。
这是为了避免中间人攻击（man-in-the-middle attack），在这类攻击中，攻击者试图
假扮成另一台计算机。在第一次连接到服务器上时，SSH默认会存储指纹信息，
在之后的连接过程中核对该指纹

SSH服务器默认在端口22上运行。但有些SSH服务器并没有使用这个端口。
针对这种情况，可以用ssh命令的-p port_num来指定端口

```shell
ssh user@locahost -p 422
```



在远程主机中执行命令，在本地shell中显示命令输出：

```shell
ssh user@host 'COMMANDS' 
ssh user@host "command1 ; command2 ; command3" # 可以输入多条命令，命令之间用分号分隔
ssh mec@192.168.0.1 "echo user: $(whoami);echo OS: $(uname)" 
```



接下来是一个基于SSH的shell脚本，它用来收集一组远程主机的运行时间（uptime）。运
行时间是系统上一次加电后运行的时间，uptime命令可以返回这个时间

详见uptime.sh

补充内容：

```shell
ssh -C user@hostname COMMANDS # SSH的压缩功能
echo 'text' | ssh user@remote_host 'echo' # 将数据重定向至远程shell命令的stdin
ssh user@remote_host 'echo' < file # 重定向文件中的数据
tar -czf - LOCALFOLDER | ssh 'tar -xzvf-' # 将本地主机上的tar存档文件传给远程主机
```

#### 在远程主机上执行图形化命令

要想在远程主机上运行图像化应用你需要设置变量$DISPLAY来强制应用程序连接到本地主
机上的X服务器：

```shell
ssh user@host "export DISPLAY=:0 ; command1; command2" # 启用远程主机上的图形化输出
ssh -X user@host "command1; command2" # 想在本地主机上显示图形化输出
```

#### 通过网络传输文件

用来在网络上传输文件的命令多数都已默认包含在了Linux中。通过FTP传输文件可以使用传
统的ftp命令或更新的lftp命令，通过SSH传输文件可以使用scp和sftp。rsync命令可以实现
系统间的文件同步

文件传输协议（File Transfer Protocol，FTP）是一个古老的协议，在很多公共站点上用于文
件共享。FTP服务器通常运行在端口21上。远程主机上必须安装并运行FTP服务器才能使用FTP。
我们可以使用传统的ftp命令或更新的lftp命令访问FTP服务器

```shell
 lftp username@ftphost 
```

提示输入密码：

```shell
lftp username@ftphost:~> 
```

- cd directory：更改远程主机目录

- lcd：更改本地主机目录

- mkdir：在远程主机上创建目录

- ls：列出远程主机当前目录下的文件

- get FILENAME：将文件下载到本地主机的当前目录中

  ```shell
  lftp username@ftphost:~> get filename 
  ```

- put filename：将文件从当前目录上传到远程主机

  ```shell
  lftp username@ftphost:~> put filename 
  ```

- quit命令可以退出lftp会话

补充内容

1. FTP自动传输

​    详见ftp_transfer.sh

2. SFTP（Secure FTP，安全FTP）

SFTP是一个运行在SSH连接之上并模拟了FTP接口的文件传输系统。它不需要远端运行FTP
服务器来进行文件传输，但必须要有SSH服务器。sftp是一个交互式命令，提供了命令提示符

sftp支持与ftp和lftp相同的命令

```shell
sftp user@domainname # 启动sftp会话
quit # 退出会话
sftp -oPort=422 user@slynux.org # 选项-oPort=PORTNO来指定端口号，应该作为sftp命令的第一个参数
```

3. rsync命令

rsync命令广泛用于网络文件复制以及备份

4. SCP（Secure Copy Program，安全复制程序）

SCP是一个安全的文件复制命令，和旧式的、不安全的远程复制命令rcp类似。文件均通过
SSH加密通道进行传输

```shell
 scp filename user@remotehost:/home/path
 scp user@remotehost:/home/path/filename filename # scp SOURCE DESTINATION 
```

选项-oPort指定其他端口

5. 用SCP进行递归复制  

   scp的选项-r可以在两台网络主机间以递归形式复制目录

```shell
scp -r /home/usernameuser@remotehost:/home/backups # 将目录/home/username递归复制到远程主机中
```

scp的选项-p能够在复制文件的同时保留文件的权限和模式