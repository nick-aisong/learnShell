在云端
========
| 目录                | 主要命令 |
| ------------------- | -------- |
| 使用Linux容器       |          |
| 使用Docker          |          |
| 在Linux中使用虚拟机 |          |
| 云端的Linux         |          |

现代Linux应用可以部署在专门的硬件、容器、虚拟机（VM）或是云端。这些解决方案有各
自优劣，都可以使用脚本或GUI进行配置和维护

如果你想部署单个应用的多个副本，每个副本都需要有自己的私有数据，那么容器就是一种
理想的选择。例如，容器可以很好地同数据库驱动的Web服务器配合工作，其中每个服务器使用
相同的Web基础设施，同时拥有私有数据

容器的缺点在于它依赖于主机的系统内核。你可以在Linux主机上运行多个Linux发行版，但
无法在容器中运行Windows

如果实例需要各不相同的完整运行环境，虚拟机是最好的方案。借助于虚拟机，你可以在单
个主机上运行Windows和Linux。如果不想在产品测试的时候摆上一大堆测试用机，但又需要在
不同的发行版和操作系统上测试，应该考虑使用虚拟机

虚拟机的缺点在于要占用大量的磁盘空间。每个虚拟机都包含了完整的计算机操作系统、设
备驱动程序、全部的应用程序和实用工具等。Linux虚拟机需要至少一个处理核心和1GB内存，
Windows虚拟机可能需要两个处理核心和4GB内存。如果你想同时运行多个虚拟机，必须有足够
的内存来支撑各个虚拟机。否则，主机就不得不开始交换页面，影响到系统性能

云就像是给了你大量可支配的计算机和带宽。你可能实际上是运行在云中的虚拟机或容器
中，也可能拥有自己专属的系统

云最大的优势在于可伸缩性。如果应用程序的规模会扩展或是使用模式上呈现出周期性的变
化，那么能够在不用购买或租借新的硬件或带宽情况下实现资源的快速扩充或缩减就很有必要
了。举例来说，如果你的系统需要处理学生注册，那么会出现一年两次，一次两周的超负荷工作
状态，而余下的时间里，基本上就没什么事了。你可能需要一堆硬件来应付这两周的工作，但是
又不想让这些硬件忙完之后闲置起来

云的缺点在于你无法直观地感知到它。所有的维护及配置工作都是远程完成的

#### 使用Linux容器

Linux容器（Linux Container，lxc）包提供了Docker和LXD容器部署系统所用到的基本容器
功能

Linux容器利用了内核对于控制组（Control Group，cgroup）的支持以及第12章中介绍过的
systemd工具。cgroups提供了能够控制程序组可用资源的工具。这些工具可以告知内核可供容器
中所运行的进程使用的资源。容器能够有限地访问设备、网络、内存等。在资源上的控制能够避
免容器之间的干扰或是对主机系统可能造成的破坏

市面上的发行版并不支持容器。你需要单独安装。不同的发行版在这方面的支持力度各不相
同。lxc容器系统是由Canonical开发的，因而Ubuntu发行版具备完善的容器支持。Debian 9（Stretch）
的表现要比Debian 8（Jessie）要好

Fedora提供了有限的lxc容器支持。创建特权容器和桥接以太网连接并不难，但是在Fedora 25
中，无法使用非特权容器所需要的cgmanager服务

SuSE也只提供了有限的lxc容器支持。SuSE的libvirt-lxc包和lxc功能类似，却不尽相同。
本章不会涉及该包。不包含以太网的特权容器在SuSE中很容易创建，但它不支持非特权容器和
桥接以太网

下面演示了如何在各种主流发行版中安装lxc支持

```shell
# 在Ubuntu中，使用下列命令：
$ sudo apt-get install lxc1 

# Debian可能只在/egc/apt/sources.list中包含了安全仓库
# 如果是这样的话，你需要将debhttp://ftp.us.debian.org/debian stretch main contrib添加到/etc/apt/sources.list中，然后执行apt-get updatebefore，载入lxc包：
$ sudo apt-get install lxc1

# 在OpenSuSE中，使用下列命令：
$ sudo zypper install lxc

# RedHat, Fedora:
# 在基于Red Hat/Fedora的系统中，添加Epel仓库：
$ sudo yum install epel-release 

# 然后再安装下列软件包：
$ sudo yum install perl libvirt debootstrap

# libvirt包提供了联网支持，debootstrap用于运行基于Debian的容器：
$ sudo yum install lxc lxc-templates tunctl bridge-utils 
```

lxc包向系统中添加了以下几条命令

- lxc-create：创建lxc容器
- lxc-ls：列出可用的容器
- lxc-start：启动容器
- lxc-stop：停止容器
- lxc-attach：附着到容器的root shell
- lxc-console：连接到容器中的登录会话

在基于Red Hat的系统中，你需要在测试的时候禁用SELinux。在OpenSuSE系统中，你需要
禁止AppArmor。通过yast2禁用AppArmor之后别忘了重启

Linux容器分为两类：特权和非特权。特权容器是由root创建的，其底层系统拥有root权限。
非特权容器是由普通用户创建的，只拥有该用户所具有的权限

特权容器更容易创建，受支持的范围也更大，因为这种类型的容器不要求uid和gid映射、设
备权限等。但如果用户或应用程序从容器中逃离（escape），它们将拥有主机系统所有的访问权限

创建特权容器可以很好地验证所需要的软件包是否都已经安装妥当。在这之后，对应用程序
使用非特权容器

1. 创建特权容器

```shell
# Linux容器最简单的上手方法就是下载一个包含在特权容器中的预构建发行版
# lxc-create命令会创建一个基础容器结构（base container structure），然后可以在其中添加定义好的Linux发行版

# lxc-create命令语法如下：
lxc-create -n NAME -t TYPE 
# 选项-n定义了容器名称
# 在启动、停止或重新配置容器时需要用到该名称
# 选项-t定义了创建容器时使用的模板
# download类型会将系统连接到包含预构建容器的仓库并提示下载容器

# 这是体验其他发行版或创建依赖非主机Linux发行版的应用程序最简单的方法：
$ sudo lxc-create -t download -n ContainerName 

# download模板会从Internet检索可用的预定义容器列表并从中生成容器
# 该命令会显示出这些可用容器并提示相应的Distribution、Release和Architecture
# 你能够运行的容器必须和硬件所支持的Architecture相符
# 如果你的系统用的是Intel的CPU，那就没法运行Arm容器，但是你可以在配备了64位Intel CPU的系统上运行32位i386容器：
$ sudo lxc-create -t download -n ubuntuContainer
...
ubuntu zesty armhf default 20170225_03:49
ubuntu zesty i386 default 20170225_03:49
ubuntu zesty powerpc default 20170225_03:49
ubuntu zesty ppc64el default 20170225_03:49
ubuntu zesty s390x default 20170225_03:49
---

Distribution: ubuntu
Release: trusty
Architecture: i386
Downloading the image index
Downloading the rootfs
Downloading the metadata
The image cache is now ready
Unpacking the rootfs

---
You just created an Ubuntu container (release=trusty, arch=i386,
variant=default)
To enable sshd, run: apt-get install openssh-server
For security reason, container images ship without user accounts and
without a root password.
Use lxc-attach or chroot directly into the rootfs to set a root password or
create user accounts. 

# 你可以根据当前使用的发行版创建容器，这只需要选择和该发行版匹配的模板就行了
# /usr/share/lxc/templates中定义了各种模板：
$ sudo ls /usr/share/lxc/templates
lxc-busybox lxc-debian lxc-download ... 

# 选择对应的模板，然后运行lxc-create命令就可以为当前发行版创建容器了
# 下载及安装过程要花费几分钟时间
# 下面的例子略去了大部分安装和配置信息：
$ cat /etc/issue
Debian GNU/Linux 8

$ sudo lxc-create -t debian -n debianContainer
debootstrap is /usr/sbin/debootstrap
Checking cache download in /var/cache/lxc/debian/rootfs-jessie-i386 ...
Downloading debianminimal ...
I: Retrieving Release
I: Retrieving Release.gpg
I: Checking Release signature
I: Valid Release signature (key id
75DDC3C4A499F1A18CB5F3C8CBF8D6FD518E17E1)
...
I: Retrieving Packages
I: Validating Packages
I: Checking component main on http://http.debian.net/debian...
I: Retrieving acl 2.2.52-2
I: Validating acl 2.2.52-2
I: Retrieving libacl1 2.2.52-2
I: Validating libacl1 2.2.52-2
I: Configuring libc-bin...
I: Configuring systemd...
I: Base system installed successfully.
Current default time zone: 'America/New_York'
Local time is now: Sun Feb 26 11:38:38 EST 2017.
Universal Time is now: Sun Feb 26 16:38:38 UTC 2017.
Root password is 'W+IkcKkk', please change !
# 上述命令会从包管理器定义的仓库中生成一个新的容器。在使用容器之前，必须先启动容器
```

2. 启动容器

```shell
# lxc-start命令可以启动容器。和其他lxc命令一样，必须提供要启动的容器名称：
$ sudo lxc-start -n ubuntuContainer 

# 容器在启动过程中有可能会挂起并输出像下面这样的错误信息
# 这是由于容器在启动时尝试在不具备图形化支持的客户端上执行图形相关的操作（例如显示启动画面）：
<4>init: plymouth-upstart-bridge main process (5) terminated with
status 1
... 
# 你可以不去管它，等待这些错误信息超时，或是禁用启动画面
# 具体的禁用方法在不同的发行版中各不相同
# 相关文件可能存放在/etc/init中，但也可能不在

# 有两种方法可以进入容器
# lxc-attach：可以直接附着到容器中的root用户
# lxc-console：打开终端，进入容器中的登录会话

# 直接附着到容器中的root用户，创建新用户：
$ sudo lxc-attach -n containerName
root@containerName:/#
root@containerName:/# useradd -d /home/USERNAME -m USERNAME
root@containerName:/# passwd USERNAME
Enter new UNIX password:
Retype new UNIX password: 

# 然后使用lxc-console命令，以之前创建的非特权用户或root用户身份登录：
$ lxc-console -n containerName
Connected to tty 1
Type <Ctrl+a q> to exit the console,
<Ctrl+aCtrl+a> to enter Ctrl+a itself
Login:
```

3. 停止容器

```shell
# lxc-stop命令可以停止容器运行：
$ sudo lxc-stop -n containerName 
```

4. 列出现有容器

```shell
# lxc-ls命令可以列出当前用户可用的容器名称
# 这些容器只是当前用户所拥有的，并非系统中所有的容器：
$ lxc-ls
container1Name container2Name...
```

5. 显示容器信息

```shell
# lxc-info命令可以显示容器信息：
$ lxc-info -n containerName
Name: testContainer
State: STOPPED 

# 该命令只会显示单个容器的信息。我们可以利用第1章中讲过的shell循环显示出所有的容器信息：
$ for c in `lxc-ls`
do
  lxc-info -n $c
  echo
done

Name: name1 
State: STOPPED

Name: name2
State: RUNNING
PID: 1234
IP 10.0.3.225
CPU use: 4.48 seconds
BlkIO use: 728.00 KiB
Memory use: 15.07 MiB
KMem use: 2.40 MiB
Link: vethMU5I00
 TX bytes: 20.48 KiB
 RX bytes: 30.01 KiB
 Total bytes: 50.49 KiB
# 如果容器处于停止状态，则不会有状态信息输出
# 正在运行的容器会记录其CPU、内存、磁盘、I/O以及网络使用信息
# 这个工具可以让你监视最活跃的容器
```

6. 创建非特权容器

非特权容器推荐用于普通用途。错误配置的容器或应用程序有可能会导致容器失控。因为容
器使用的是内核的系统调用，如果容器是以root权限运行，那么系统调用的权限同样也是root。
但非特权容器使用的是普通用户权限，因此要更安全

```shell
# 主机必须支持Linux控制组（Linux Control Group）以及uid映射才能够创建非特权容器
# Ubuntu发行版本身已经包含了这方面的支持，其他发行版需要自行添加

# 有些发行版中并没有cgmanager包。这个包是启动非特权容器的前提条件：
$ sudo apt-get install cgmanager uidmap systemd-services

# 启动cgmanager：
$ sudo service cgmanager start 

# Debian系统可能还需要启用克隆支持。如果在创建容器时出现chown错误，使用下面的命令来解决：
$ sudo echo 1 > /sys/fs/cgroup/cpuset/cgroup.clone_children
$ sudo echo 1 > /proc/sys/kernel/unprivileged_userns_clone 

# 允许创建容器的用户名必须包含在/etc下的映射表中：
$ sudo usermod --add-subuids 100000-165536 $USER
$ sudo usermod --add-subgids 100000-165536 $USER
$ sudo chmod +x $HOME
# 上述命令将用户添加到User ID和Group ID映射表中（/etc/subuid和/etc/subgid）并将范围在100 000至165 536之间的UID分配给该用户

# 接下来，设置容器的配置文件：
$ mkdir ~/.config/lxc
$ cp /etc/lxc/default.conf ~/.config/lxc 

# 将下面两行添加到~/.config/lxc/default.conf：
lxc.id_map = u 0 100000 65536
lxc.id_map = g 0 100000 65536 

# 如果容器支持网络访问，将下面一行添加到/etc/lxc/lxc-usernet，该行定义了谁能够访问网桥：
USERNAME veth BRIDGENAME COUNT 

# 在这里，USERNAME是容器的所有者
# veth是虚拟以太网设备的常用名称。
# BRIDGENAME是ifconfig显示的名称，一般是br0或lxcbro
# COUNT是允许的并发连接数：
$ cat /etc/lxc/lxc-usernet
Clif veth lxcbr0 10 
```

7. 创建网桥

```shell
# 容器不能直接访问以太网适配器
# 它需要在虚拟以太网和真实以太网之间搭建一个桥梁。
# 最近的Ubuntu发行版会在安装lxc包的时候自动创建网桥
# Debian和Fedora需要手动创建网桥
# 在Fedora中创建网桥时，首先需要使用libvirt包创建虚拟网桥：

$ sudo systemctl start libvirtd 

# 然后，编辑/etc/lxc/default.conf，将其中的引用由lxcbr0改为virbr0：
lxc.network_link = virbr0

# 如果你已经创建好了容器，按照上面的方法修改容器的配置文件
# 在Debian系统中创建网桥时，必须编辑网络配置文件以及容器配置文件
# 编辑/etc/lxc/default.conf，将默认值为empty的配置项注释掉，然后加入lxc网桥的定义：
# lxc.network.type = empty
lxc.network.type = veth
lxc.network.link = lxcbr0
lxc.network.flage = up 

# 接下来，创建网桥：
$ sudo systemctl enable lxc-net
$ sudo systemctl start lxc-net
# 经过这些设置之后，新创建的容器就可以联网了
# 将lxc.network这几行加入到已有容器的配置文件中，就可以为其添加网络支持
```

工作原理

```shell
# lxc-create命令所创建的容器是一个目录树，其中包含了配置选项以及容器的根文件系统
# 特权容器位于/var/lib/lxc。非特权容器位于$HOME/.local/lxc：
$ ls /var/lib/lxc/CONTAINERNAME
config rootfs

# 你可以通过编辑容器顶层目录下的config文件来检查或修改容器的配置：
$ sudo vim /var/lib/lxc/CONTAINERNAME/config 

# rootfs目录中包含的就是容器的根文件系统。其内容正是运行中的容器的根目录（/）：
$ sudo ls /var/lib/lxc/CONTAINERNAME/rootfs
Bin boot cdrom dev etc home lib media mnt proc
Root run sbin sys tmp usr var
# 你可以通过添加、删除或修改rootfs目录中的文件来改变容器的内容
# 例如，要想运行Web服务，容器可以利用包管理器来安装基本的Web服务，通过将文件复制到rootfs目录来提供服务所用到的实际数据
```

#### 使用Docker

lxc容器非常复杂，不易使用。这就催生出了Docker。Docker使用了相同的Linux底层功能
（namespaces和cgroups）来创建轻量级容器

Docker只正式支持64位系统，对于遗留系统来说，lxc是一种更好的选择

Docker容器和lxc容器的主要区别在于前者通常只使用一个进程，而后者要使用多个。要部署
一个带有数据库支撑的Web服务器，你需要至少两个Docker容器：一个用于Web服务器，另一个
用于数据库服务器。如果使用lxc容器的话，一个就够了

Docker的设计哲学使得我们很容易从小的构建块（building block）入手来构造系统，但也增
加了开发构建块的难度，因为在完整的Linux系统中（包括crontab表项），需要运行大量的工具
来执行清理、日志回卷等操作













#### 在Linux中使用虚拟机











#### 云端的Linux
















